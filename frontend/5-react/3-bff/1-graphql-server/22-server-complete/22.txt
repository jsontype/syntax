[í¬ìŠ¤íŠ¸ ë‚˜ë¨¸ì§€ ëª¨ë‘ ì¶”ê°€í•˜ê¸°]

1. ì‚¬ì „ì¤€ë¹„ : í”„ë¡œì íŠ¸ë¥¼ ìƒˆë¡œ ê¹”ì§€ ì•Šê³ , ì´ì „ ì±•í„°ì—ì„œì˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì¹´í”¼í•´ì„œ ê°€ì§€ê³  ì˜¨ë‹¤.

1. í¬ìŠ¤íŠ¸ ë‚˜ë¨¸ì§€ ëª¨ë‘ ì¶”ê°€í•˜ê¸°
  ì´ë²ˆ ì±•í„°ì—ì„œ ì„œë²„ ì•±ì„ ëª¨ë‘ ì™„ì„±ì‹œí‚¤ê² ë‹¤.



1. dbWorks.js ìˆ˜ì • : ë‚˜ë¨¸ì§€ DB ê´€ë ¨ í•¨ìˆ˜ ëª¨ë‘ ì¶”ê°€
  const database = require('./database.js')

  const dataFiltered = (which, args) => {
    let result = database[which].filter((item) => {
      // ì¡°ê±´ì¸ìê°€ ì—†ê±°ë‚˜, í˜ì´ì§• ê´€ë ¨ ì¸ìê±°ë‚˜
      // ëª¨ë“  ìš”ì†Œê°€ ì•„ì´í…œê³¼ ëª¨ë‘ ì¼ì¹˜í•˜ë©´ í†µê³¼
      return (
        !args ||
        Object.keys(args).reduce((a, b) => {
          return a && (["page", "per_page"].includes(b) || item[b] == args[b])
        }, true)
      )
    })

    // í˜ì´ì§•
    if (args.page && args.per_page) {
      result = result.slice(
        (args.page - 1) * args.per_page,
        args.page * args.per_page
      )
    }

    return result
  }

  const dbWorks = {
    deleteItem: (which, args) => {
      const deleted = database[which].filter((item) => {
        return item.id == args.id
      })[0]
      database[which] = database[which].filter((item) => {
        return item.id != args.id
      })
      return deleted
    },

    getTeams: (args) =>
      dataFiltered("teams", args).map((team) => {
        team.members = dbWorks.getPeople({ team: team.id })
        return team
      }),
    postTeam: (args) => {
      const newTeam = {
        id:
          database.teams
            .map((team) => {
              return Number(team.id)
            })
            .reduce((a, b) => {
              return Math.max(a, b)
            }, 0) + 1,
        ...args.input,
      }
      database.teams.push(newTeam)
      return newTeam
    },
    editTeam: (args) => {
      return database.teams
        .filter((team) => {
          return team.id == args.id
        })
        .map((team) => {
          Object.assign(team, args.input)
          return team
        })[0]
    },

    getPeople: (args) =>
      dataFiltered("people", args).map((person) => {
        person.tools = [
          ...dbWorks.getEquipments({ used_by: person.role }),
          ...dbWorks.getSoftwares({ used_by: person.role }),
        ]
        person.givens = [
          ...dbWorks.getEquipments({ used_by: person.role }),
          ...dbWorks.getSupplies({ team: person.team }),
        ]
        return person
      }),
    postPerson: (args) => {
      const newPerson = {
        id:
          database.people
            .map((person) => {
              return Number(person.id)
            })
            .reduce((a, b) => {
              return Math.max(a, b)
            }, 0) + 1,
        ...args.input,
      }
      database.people.push(newPerson)
      return newPerson
    },
    editPerson: (args) => {
      return database.people
        .filter((person) => {
          return person.id == args.id
        })
        .map((person) => {
          Object.assign(person, args.input)
          return person
        })[0]
    },

    getRoles: (args) =>
      dataFiltered("roles", args).map((role) => {
        role.members = dbWorks.getPeople({ role: role.id })
        role.equipments = dbWorks.getEquipments({ used_by: role.id })
        role.softwares = dbWorks.getSoftwares({ used_by: role.id })
        return role
      }),

    getEquipments: (args) => dataFiltered("equipments", args),
    postEquipment: (args) => {
      database.equipments.push(args)
      return args
    },
    increaseEquipment: (args) => {
      return database.equipments
        .filter((equipment) => {
          return equipment.id == args.id
        })
        .map((equipment) => {
          equipment.count += 1
          return equipment
        })[0]
    },

    getSoftwares: (args) => dataFiltered("softwares", args),

    getSupplies: (args) => dataFiltered("supplies", args),
  }

  module.exports = dbWorks



1. typedefs-resolvers/_queries.js ìˆ˜ì • : ë‚˜ë¨¸ì§€ get ë©”ì†Œë“œ ëª¨ë‘ ì¶”ê°€
  const { gql } = require("apollo-server")

  const typeDefs = gql`
    type Query {
      teams(manager: String, cleaning_duty: String): [Team]
      team(id: ID!): Team

      people(
        page: Int
        per_page: Int
        team: Int
        sex: Sex
        blood_type: BloodType
        from: String
      ): [People]
      person(id: ID!): People
      peopleFiltered(
        team: Int
        sex: Sex
        blood_type: BloodType
        from: String
      ): [People]
      peoplePaginated(page: Int!, per_page: Int!): [People]
      peopleFilteredPaginated(
        team: Int
        sex: Sex
        blood_type: BloodType
        from: String
        page: Int!
        per_page: Int!
      ): [People]

      roles: [RoleInfo]
      role(id: ID!): RoleInfo

      equipments(used_by: Role, new_or_used: NewOrUsed): [Equipment]
      equipment(id: ID!): Equipment
      equipmentAdvs: [EquipmentAdv]

      softwares(used_by: Role, developed_by: String): [Software]
      software(id: ID!): Software

      supplies(team: ID): [Supply]
      supply(id: ID!): Supply

      givens: [Given]
    }
  `

  module.exports = typeDefs



1. typedefs-resolvers/_mutations.js ìˆ˜ì • : ë‚˜ë¨¸ì§€ post ë©”ì†Œë“œ ëª¨ë‘ ì¶”ê°€
  const { gql } = require("apollo-server")

  const typeDefs = gql`
    type Mutation {
      postTeam(input: PostTeamInput!): Team!
      editTeam(id: ID!, input: PostTeamInput!): Team!
      deleteTeam(id: ID!): Team!

      deleteEquipment(id: String): Equipment
      postEquipment(
        id: ID!
        used_by: Role!
        count: Int
        new_or_used: NewOrUsed!
      ): Equipment!
      increaseEquipment(id: ID!): Equipment!

      deleteSupply(id: String): Supply

      postPerson(input: PostPersonInput): People!
      editPerson(id: ID!, input: PostPersonInput!): People!
      deletePerson(id: ID!): People!
    }
  `

  module.exports = typeDefs



1. typedefs-resolvers/teams.js ìƒì„± : teams ì¿¼ë¦¬ ì™„ì„±ì‹œí‚¤ê¸°
  const { gql } = require("apollo-server")
  const dbWorks = require("../dbWorks.js")

  const typeDefs = gql`
    type Team {
      id: ID!
      manager: String!
      office: String
      extension_number: String
      mascot: String
      cleaning_duty: String!
      project: String
      members: [People]
    }

    input PostTeamInput {
      manager: String!
      office: String
      extension_number: String
      mascot: String
      cleaning_duty: String!
      project: String
    }
  `

  const resolvers = {
    Query: {
      teams: (parent, args) => dbWorks.getTeams(args),
      team: (parent, args) => dbWorks.getTeams(args)[0],
    },
    Mutation: {
      postTeam: (parent, args) => dbWorks.postTeam(args),
      editTeam: (parent, args) => dbWorks.editTeam(args),
      deleteTeam: (parent, args) => dbWorks.deleteItem("teams", args),
    },
  }

  module.exports = {
    typeDefs: typeDefs,
    resolvers: resolvers,
  }



1. typedefs-resolvers/roles.js ìƒì„± : roles ì¿¼ë¦¬ ì™„ì„±ì‹œí‚¤ê¸°
  const { gql } = require("apollo-server")
  const dbWorks = require("../dbWorks.js")

  const typeDefs = gql`
    type RoleInfo {
      id: ID!
      job: String!
      requirement: String
      members: [People]
      equipments: [Equipment]
      softwares: [Software]
    }
  `

  const resolvers = {
    Query: {
      roles: (parent, args) => dbWorks.getRoles(args),
      role: (parent, args) => dbWorks.getRoles(args)[0],
    },
  }

  module.exports = {
    typeDefs: typeDefs,
    resolvers: resolvers,
  }



1. typedefs-resolvers/supplies.js ìˆ˜ì • : supplies ì¿¼ë¦¬ ì™„ì„±ì‹œí‚¤ê¸°
  const { gql } = require("apollo-server")
  const dbWorks = require("../dbWorks.js")

  const typeDefs = gql`
    type Supply {
      id: ID!
      team: ID!
    }
  `
  const resolvers = {
    Query: {
      supplies: (parent, args) => dbWorks.getSupplies(args),
      supply: (parent, args) => dbWorks.getSupplies(args)[0],
    },
    Mutation: {
      deleteSupply: (parent, args) => dbWorks.deleteItem("supplies", args),
    },
  }

  module.exports = {
    typeDefs: typeDefs,
    resolvers: resolvers,
  }



1. typedefs-resolvers/equipments.js ìˆ˜ì • : equipments ì¿¼ë¦¬ ì™„ì„±ì‹œí‚¤ê¸° 
  const { gql } = require("apollo-server")
  const dbWorks = require("../dbWorks")

  // implements Tool ëª…ë ¹ì–´ë¥¼ í†µí•´ Tool ì¸í„°í˜ì´ìŠ¤ë¥¼ ì ìš©í•œë‹¤.
  const typeDefs = gql`
    type Equipment implements Tool {
      id: ID!
      used_by: Role!
      count: Int
      new_or_used: NewOrUsed!
    }
    type Software implements Tool {
      id: ID!
      used_by: Role!
      developed_by: String!
      description: String
    }
    type EquipmentAdv {
      id: ID!
      used_by: String!
      count: Int!
      use_rate: Float
      is_new: Boolean!
      users: [String!]
    }
  `

  const resolvers = {
    Query: {
      equipments: (parent, args) => dbWorks.getEquipments(args),
      equipment: (parent, args) => dbWorks.getEquipments(args)[0],
      equipmentAdvs: (parent, args) =>
        dbWorks.getEquipments(args).map((equipment) => {
          if (equipment.used_by === "developer") {
            equipment.use_rate = Math.random().toFixed(2)
          }
          equipment.is_new = equipment.new_or_used === "new"
          // 50% í™•ë¥ ë¡œ equipmentAdvs í•­ëª©ì— users ë°°ì—´ì„ ì¶”ê°€í•˜ê³ , ê·¸ ì•ˆì— 20% í™•ë¥ ë¡œ ê°œë°œìë¥¼ ë„£ëŠ”ë‹¤.
          if (Math.random() > 0.5) {
            equipment.users = []
            dbWorks.getPeople(args).forEach((person) => {
              if (person.role === equipment.used_by && Math.random() < 0.2) {
                equipment.users.push(person.last_name)
              }
            })
          }
          return equipment
        }),
    },

    Mutation: {
      increaseEquipment: (parent, args) => dbWorks.increaseEquipment(args),
      deleteEquipment: (parent, args) => dbWorks.deleteItem("equipments", args),
    },
  }

  module.exports = {
    typeDefs: typeDefs,
    resolvers: resolvers,
  }



1. typedefs-resolvers/people.js ìˆ˜ì • : people ì¿¼ë¦¬ ì™„ì„±ì‹œí‚¤ê¸° 
  const { gql } = require("apollo-server")
  const dbWorks = require("../dbWorks.js")

  const typeDefs = gql`
    type People {
      id: ID!
      first_name: String!
      last_name: String!
      sex: Sex!
      blood_type: BloodType!
      serve_years: Int!
      role: Role!
      team: ID!
      from: String!
      tools: [Tool]
      givens: [Given]
    }
    input PostPersonInput {
      first_name: String!
      last_name: String!
      sex: Sex!
      blood_type: BloodType!
      serve_years: Int!
      role: Role!
      team: ID!
      from: String!
    }
  `

  const resolvers = {
    Query: {
      people: (parent, args) => dbWorks.getPeople(args),
      person: (parent, args) => dbWorks.getPeople(args)[0],
      peopleFiltered: (parent, args) => dbWorks.getPeople(args),
      peoplePaginated: (parent, args) => dbWorks.getPeople(args),
      peopleFilteredPaginated: (parent, args) => dbWorks.getPeople(args),
    },
    Mutation: {
      postPerson: (parent, args) => dbWorks.postPerson(args),
      editPerson: (parent, args) => dbWorks.editPerson(args),
      deletePerson: (parent, args) => dbWorks.deleteItem("people", args),
    },
  }

  module.exports = {
    typeDefs: typeDefs,
    resolvers: resolvers,
  }



1. index.js ìˆ˜ì • : ë‚˜ë¨¸ì§€ í•„ìš”í•œ ì¿¼ë¦¬ ëª¨ë‘ ì¶”ê°€
  const { ApolloServer } = require("apollo-server")
  const _ = require("lodash")

  const queries = require("./typedefs-resolvers/_queries")
  const mutations = require("./typedefs-resolvers/_mutations")
  const enums = require("./typedefs-resolvers/_enums")
  const teams = require("./typedefs-resolvers/teams")
  const roles = require("./typedefs-resolvers/roles")
  const equipments = require("./typedefs-resolvers/equipments")
  const supplies = require("./typedefs-resolvers/supplies")
  const softwares = require("./typedefs-resolvers/softwares")
  const givens = require("./typedefs-resolvers/givens")
  const tools = require("./typedefs-resolvers/tools")
  const people = require("./typedefs-resolvers/people")

  const typeDefs = [
    queries,
    mutations,
    enums,
    teams.typeDefs,
    roles.typeDefs,
    equipments.typeDefs,
    supplies.typeDefs,
    softwares.typeDefs,
    givens.typeDefs,
    tools.typeDefs,
    people.typeDefs,
  ]

  const resolvers = [
    teams.resolvers,
    roles.resolvers,
    equipments.resolvers,
    supplies.resolvers,
    softwares.resolvers,
    givens.resolvers,
    tools.resolvers,
    people.resolvers,
  ]

  const server = new ApolloServer({ typeDefs, resolvers })

  server.listen().then(({ url }) => {
    console.log(`ğŸš€  Server ready at ${url}`)
  })



1. í…ŒìŠ¤íŠ¸
  $ cd app1
  $ npm start
  http://localhost:4000/ ì ‘ì† : GraphQL Playgroundê°€ ì—´ë¦°ë‹¤.
  GraphQL Playground ì‚¬ìš© : ì¢Œì¸¡ì— ë‹¤ìŒ ì¿¼ë¦¬ë¥¼ ë„£ê³  Runì„ í´ë¦­
    mutation {
      postPerson(input: {
        first_name: "Hanna"
        last_name: "Kim"
        sex: female
        blood_type: O
        serve_years: 3
        role: developer
        team: 1
        from: "Pusan"
      }) {
        id
        first_name
        last_name
        sex
        blood_type
        role
        team
        from
      }
    }
  GraphQL Playground ì‚¬ìš© : ì¢Œì¸¡ì— ë‹¤ìŒ ì¿¼ë¦¬ë¥¼ ë„£ê³  Runì„ í´ë¦­
    query {
      people {
        id
        first_name
        last_name
        sex
        blood_type
        serve_years
        role
        team
        from
      }
    }
  ë§¨ëì— Hannaë¼ëŠ” ì‚¬ëŒì´ ì œëŒ€ë¡œ ì¶”ê°€ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
  (* ì¼ë‹¨ ì´ë ‡ê²Œ Post í•˜ë‚˜ë§Œ í…ŒìŠ¤íŠ¸ í–ˆì§€ë§Œ, ì´ì „ ë©”ëª¨ë“¤ì„ ë³´ë©´ì„œ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ë“¤ë„ ì´ê²ƒì €ê²ƒ ì§„í–‰í•˜ë©´ì„œ ì´ìƒì—†ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•´ë³´ì.)
