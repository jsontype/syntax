[Equipments ëª¨ë“ˆí™” - ì‚­ì œê¸°ëŠ¥]

1. ì‚¬ì „ì¤€ë¹„ : í”„ë¡œì íŠ¸ë¥¼ ìƒˆë¡œ ê¹”ì§€ ì•Šê³ , ì´ì „ ì±•í„°ì—ì„œì˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì¹´í”¼í•´ì„œ ê°€ì§€ê³  ì˜¨ë‹¤.

1. ì„¤ì¹˜
  $ cd app1

1. apollo-server ìƒì„±ìì˜ ì¸ìì¸ typeDefs, resolversë¥¼ ëª¨ë“ˆí™” í•´ì•¼í•˜ëŠ” ì´ìœ 
  í•œ íŒŒì¼ì— ë„ˆë¬´ ì½”ë“œê°€ ì§‘ì•½ë˜ì–´ ìˆë‹¤.
  ë¬¼ë¡  í•œ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•  GraphQL ì¿¼ë¦¬ê°€ ì—¬ê¸°ì„œ ëì´ë¼ë©´, ëª¨ë“ˆí™”ëŠ” êµ³ì´ í•„ìš”ì—†ì§€ë§Œ,
  ëŒ€í˜• í”„ë¡œì íŠ¸ì˜ ê²½ìš°, ì‚¬ìš©í•  GraphQL ì¿¼ë¦¬ì˜ ìˆ˜ê°€ ìƒë‹¹íˆ ë§ì•„ì ¸ì„œ,
  ì´ëŒ€ë¡œ í•œ íŒŒì¼ì— ì½”ë“œë¥¼ ì§‘ì•½í•´ë‘ë©´ ë‚˜ì¤‘ì— ìœ ì§€ë³´ìˆ˜ ë° ê´€ë¦¬ê°€ í˜ë“¤ê¸° ë•Œë¬¸ì— ëª¨ë“ˆí™”ê°€ í•„ìˆ˜ê°€ ëœë‹¤.
  ì´ëŸ´ ë•ŒëŠ” ê´€ë¦¬ë¥¼ ìœ„í•´ apollo-server ìƒì„±ìì˜ ì¸ìì¸ typeDefs, resolversë“¤ì„ ëª¨ë“ˆí™”í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.



1. dbWorks.js ìƒì„± : "ì—¬ëŸ¬ê°€ì§€ Mock Database ì¡°ì‘ í•¨ìˆ˜"ë“¤ì„ ì •ë¦¬í•´ë‘” ê²ƒ. ì´í›„ equipments.js, supplies.jsì•ˆì˜ ê° resolvers ê°ì²´ì—ì„œ í˜¸ì¶œí•´ì„œ ì‚¬ìš©í•  ê²ƒì´ë‹¤.
  const database = require('./database.js')

  const dataFiltered = (which, args) => {
    let result = database[which].filter((item) => {
      // ì¡°ê±´ì¸ìê°€ ì—†ê±°ë‚˜, í˜ì´ì§• ê´€ë ¨ ì¸ìê±°ë‚˜
      // ëª¨ë“  ìš”ì†Œê°€ ì•„ì´í…œê³¼ ëª¨ë‘ ì¼ì¹˜í•˜ë©´ í†µê³¼
      return !args || Object.keys(args).reduce((a, b) => {
        return a && (
          ['page', 'per_page'].includes(b) ||
          item[b] == args[b]
        )
      }, true)
    })

    // í˜ì´ì§•
    if (args.page && args.per_page) {
      result = result.slice(
        (args.page - 1) * args.per_page, 
        args.page * args.per_page
      )
    }

    return result
  }

  const dbWorks = {
    deleteItem: (which, args) => {
      const deleted = database[which].filter((item) => {
        return item.id == args.id
      })[0]
      database[which] = database[which].filter((item) => {
        return item.id != args.id
      })
      return deleted
    },

    getTeams: (args) => dataFiltered('teams', args)
      .map((team) => {
        team.members = dbWorks.getPeople({team: team.id})
        return team
      }),

    postTeam: (args) => {
      const newTeam = {
        id: database.teams.map((team) => {
          return Number(team.id)
        }).reduce((a, b) => {
          return Math.max(a, b)
        }, 0) + 1,
        ...args.input
      }
      database.teams.push(newTeam)
      return newTeam
    },

    editTeam: (args) => {
      return database.teams.filter((team) => {
        return team.id == args.id
      }).map((team) => {
        Object.assign(team, args.input)
        return team 
      })[0]
    },

    getPeople: (args) => dataFiltered('people', args) 
      .map((person) => {
        person.tools = [
          ...dbWorks.getEquipments({used_by: person.role}),
          ...dbWorks.getSoftwares({used_by: person.role})
        ]
        person.givens = [
          ...dbWorks.getEquipments({used_by: person.role}),
          ...dbWorks.getSupplies({team: person.team})
        ]
        return person
      }),

    postPerson: (args) => {
      const newPerson = {
        id: database.people.map((person) => {
          return Number(person.id)
        }).reduce((a, b) => {
          return Math.max(a, b)
        }, 0) + 1,
        ...args.input
      }
      database.people.push(newPerson)
      return newPerson
    },

    editPerson: (args) => {
      return database.people.filter((person) => {
        return person.id == args.id
      }).map((person) => {
        Object.assign(person, args.input)
        return person 
      })[0]
    },

    getRoles: (args) => dataFiltered('roles', args)
      .map((role) => {
        role.members = dbWorks.getPeople({role: role.id})
        role.equipments = dbWorks.getEquipments({used_by: role.id})
        role.softwares = dbWorks.getSoftwares({used_by: role.id})
        return role
      }),

    getEquipments: (args) => dataFiltered('equipments', args),

    postEquipment: (args) => {
      database.equipments.push(args)
      return args
    },

    increaseEquipment: (args) =>{
      return database.equipments.filter((equipment) => {
        return equipment.id == args.id
      }).map((equipment) => {
        equipment.count += 1 
        return equipment
      })[0]
    },

    getSoftwares: (args) => dataFiltered('softwares', args),

    getSupplies: (args) => dataFiltered('supplies', args),
  }

  module.exports = dbWorks



1. typedefs-resolvers/equipments.js ìƒì„± : equipments ëª¨ë“ˆí™”
  const { gql } = require('apollo-server')
  const dbWorks = require('../dbWorks')

  const typeDefs = gql`
    type Equipment {
      id: String
      used_by: String
      count: Int
      new_or_used: String
    }
  `
  const resolvers = {
    Query: {
      equipments: (parent, args) => dbWorks.getEquipments(args),
    },
    Mutation: {
      deleteEquipment: (parent, args) => dbWorks.deleteItem('equipments', args),
    }
  }

  module.exports = {
    typeDefs: typeDefs,
    resolvers: resolvers
  }



1. typedefs-resolvers/supplies.js ìƒì„± : Supply ëª¨ë“ˆí™”
  const { gql } = require('apollo-server')
  const dbWorks = require('../dbWorks')

  const typeDefs = gql`
    type Supply {
      id: String
      team: Int
    }
  `

  const resolvers = {
    Query: {
      supplies: (parent, args) => dbWorks.getSupplies(args)
    },
    Mutation: {
      deleteSupply: (parent, args) => dbWorks.deleteItem('supplies', args),
    }
  }

  module.exports = {
    typeDefs: typeDefs,
    resolvers: resolvers
  }



1. typedefs-resolvers/_queries.js ìƒì„± : equipmentsì˜ Query ëª¨ë“ˆí™”
  const { gql } = require('apollo-server')

  const typeDefs = gql`
    type Query {
      equipments: [Equipment]
      supplies: [Supply]
    }
  `

  module.exports = typeDefs



1. typedefs-resolvers/_mutations.js ìƒì„± : equipmentsì˜ Mutation ëª¨ë“ˆí™”
  const { gql } = require('apollo-server')

  const typeDefs = gql`
    type Mutation {
      deleteEquipment(id: String): Equipment
      deleteSupply(id: String): Supply
    }
  `

  module.exports = typeDefs



1. index.js ìˆ˜ì • : ëª¨ë“ˆí™”ëœ equipmentsì™€ suppliesì˜ ê°ê°ì˜ typeDefs, resoleversë¥¼ ë£¨íŠ¸ëª¨ë“ˆì— ì ìš©ì‹œí‚¨ë‹¤.
  const { ApolloServer } = require('apollo-server')

  const queries = require('./typedefs-resolvers/_queries')
  const mutations = require('./typedefs-resolvers/_mutations')
  const equipments = require('./typedefs-resolvers/equipments')
  const supplies = require('./typedefs-resolvers/supplies')

  const typeDefs = [
    queries,
    mutations,
    equipments.typeDefs,
    supplies.typeDefs,
  ]

  const resolvers = [
    equipments.resolvers,
    supplies.resolvers
  ]

  const server =  new ApolloServer({ typeDefs, resolvers })

  server.listen().then(({url}) => {
    console.log(`ğŸš€  Server ready at ${url}`)
  })



1. equipments ì‚­ì œ í…ŒìŠ¤íŠ¸
  $ cd app1
  $ npm start
  http://localhost:4000/ ì ‘ì† : GraphQL Playgroundê°€ ì—´ë¦°ë‹¤.
  GraphQL Playground ì‚¬ìš© : ì¢Œì¸¡ì— ë‹¤ìŒ ì¿¼ë¦¬ë¥¼ ë„£ê³  Runì„ í´ë¦­
    mutation {
      deleteEquipment(id: "notebook") {
        id
        used_by
        count
        new_or_used
      }
    }
  GraphQL Playground ì‚¬ìš© : ì¢Œì¸¡ì— ë‹¤ìŒ ì¿¼ë¦¬ë¥¼ ë„£ê³  Runì„ í´ë¦­
    query {
      equipments {
        id
        used_by
        count
        new_or_used
      }
    }
  idê°€ "notebook"ì¸ equipmentê°€ ì‚­ì œ ë˜ì—ˆëŠ”ì§€ í™•ì¸ 



1. supplies ì‚­ì œ í…ŒìŠ¤íŠ¸
  $ cd app1
  $ npm start
  http://localhost:4000/ ì ‘ì† : GraphQL Playgroundê°€ ì—´ë¦°ë‹¤.
  GraphQL Playground ì‚¬ìš© : ì¢Œì¸¡ì— ë‹¤ìŒ ì¿¼ë¦¬ë¥¼ ë„£ê³  Runì„ í´ë¦­
    mutation {
      deleteSupply(id: "mug") {
        id
        team
      }
    }
  GraphQL Playground ì‚¬ìš© : ì¢Œì¸¡ì— ë‹¤ìŒ ì¿¼ë¦¬ë¥¼ ë„£ê³  Runì„ í´ë¦­
    query {
      supplies {
        id
        team
      }
    }
  idê°€ "mug"ì¸ supplyê°€ ì‚­ì œ ë˜ì—ˆëŠ”ì§€ í™•ì¸ 



1. ë§ˆë¬´ë¦¬
  equipments, suppliesì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ people, roles, softwares, teamsë¥¼ ì¶”ê°€í•˜ë©´ ë˜‘ê°™ì€ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ë‹¤.
  ì‹œê°„ê´€ê³„ìƒ ìƒëµí•˜ê² ë‹¤.
